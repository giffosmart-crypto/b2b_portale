{% extends "backoffice/base_admin.html" %}

{% block admin_content %}

<div class="max-w-5xl mx-auto space-y-6">
<div class="space-y-4 md:space-y-6">

  <!-- HEADER -->
  <div class="flex items-center justify-between gap-3">
    <div>
      <h1 class="text-xl font-semibold text-slate-900">
        Recensioni prodotti
      </h1>
      <p class="text-sm text-slate-500 mt-1">
        Modera le recensioni inserite dai clienti, filtra per partner e prodotto, approva o rifiuta i contenuti.
      </p>
    </div>

    <div class="hidden md:flex items-center gap-3">
      <span class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1 text-xs font-medium text-slate-600 bg-slate-50">
        Totale: {{ reviews|length }} recensioni
      </span>
    </div>
  </div>

  <!-- FILTRI -->
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 md:p-5">
    <form method="get" class="space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">

        <!-- Prodotto -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide">
            Prodotto
          </label>
          <select name="product" class="block w-full rounded-xl border-slate-200 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Tutti</option>
            {% for p in products %}
              <option value="{{ p.id }}" {% if selected_product == p.id %}selected{% endif %}>
                {{ p.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Partner -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide">
            Partner
          </label>
          <select name="partner" class="block w-full rounded-xl border-slate-200 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Tutti</option>
            {% for partner in partners %}
              <option value="{{ partner.id }}" {% if selected_partner == partner.id %}selected{% endif %}>
                {{ partner.company_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Rating minimo -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide">
            Rating minimo
          </label>
          <select name="rating_min" class="block w-full rounded-xl border-slate-200 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">--</option>
            {% for r in "12345" %}
              <option value="{{ r }}" {% if rating_min == r %}selected{% endif %}>{{ r }}+</option>
            {% endfor %}
          </select>
        </div>

        <!-- Stato -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide">
            Stato
          </label>
          <select name="status" class="block w-full rounded-xl border-slate-200 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="" {% if not status %}selected{% endif %}>Tutti</option>
            <option value="pending" {% if status == "pending" %}selected{% endif %}>In attesa</option>
            <option value="approved" {% if status == "approved" %}selected{% endif %}>Approvate</option>
            <option value="rejected" {% if status == "rejected" %}selected{% endif %}>Rifiutate</option>
          </select>
        </div>

        <!-- Ricerca -->
        <div class="space-y-1">
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide">
            Ricerca
          </label>
          <input
            type="text"
            name="q"
            value="{{ search }}"
            placeholder="Testo, utente, prodotto"
            class="block w-full rounded-xl border-slate-200 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
          >
        </div>

      </div>

      <div class="flex flex-wrap items-center gap-2 pt-1">
        <button
          type="submit"
          class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1"
        >
          Applica filtri
        </button>

        <a
          href="{% url 'backoffice:review_list' %}"
          class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50"
        >
          Reset
        </a>

        <!-- Pills stato rapido -->
        <div class="flex flex-wrap items-center gap-2 ml-auto text-xs">
          <span class="text-slate-400 mr-1">Rapido:</span>
          <a href="?status=pending" class="inline-flex items-center rounded-full border px-2.5 py-1 {% if status == 'pending' %}border-amber-400 bg-amber-50 text-amber-700{% else %}border-slate-200 text-slate-500 hover:bg-slate-50{% endif %}">
            In attesa
          </a>
          <a href="?status=approved" class="inline-flex items-center rounded-full border px-2.5 py-1 {% if status == 'approved' %}border-emerald-400 bg-emerald-50 text-emerald-700{% else %}border-slate-200 text-slate-500 hover:bg-slate-50{% endif %}">
            Approvate
          </a>
          <a href="?status=rejected" class="inline-flex items-center rounded-full border px-2.5 py-1 {% if status == 'rejected' %}border-rose-400 bg-rose-50 text-rose-700{% else %}border-slate-200 text-slate-500 hover:bg-slate-50{% endif %}">
            Rifiutate
          </a>
        </div>
      </div>
    </form>
  </div>

  <!-- LISTA RECENSIONI -->
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
    <table class="min-w-full divide-y divide-slate-200 text-sm">
      <thead class="bg-slate-50">
        <tr class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          <th class="px-3 py-2 text-left">ID</th>
          <th class="px-3 py-2 text-left">Data</th>
          <th class="px-3 py-2 text-left">Prodotto</th>
          <th class="px-3 py-2 text-left">Partner</th>
          <th class="px-3 py-2 text-left">Cliente</th>
          <th class="px-3 py-2 text-left">Rating</th>
          <th class="px-3 py-2 text-left">Stato</th>
          <th class="px-3 py-2 text-left">Commento</th>
          <th class="px-3 py-2 text-right"></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% if reviews %}
          {% for r in reviews %}
            <tr class="hover:bg-slate-50">
              <td class="px-3 py-2 align-top text-xs text-slate-500">
                #{{ r.id }}
              </td>

              <td class="px-3 py-2 align-top text-xs text-slate-500">
                {{ r.created_at|date:"d/m/Y H:i" }}
              </td>

              <td class="px-3 py-2 align-top">
                <div class="text-sm font-medium text-slate-900">
                  {{ r.product.name }}
                </div>
              </td>

              <td class="px-3 py-2 align-top text-sm text-slate-600">
                {% if r.product.supplier %}
                  {{ r.product.supplier.company_name }}
                {% else %}
                  <span class="text-slate-400 text-xs">Nessun partner</span>
                {% endif %}
              </td>

              <td class="px-3 py-2 align-top text-sm text-slate-600">
                {{ r.user.email }}
              </td>

              <td class="px-3 py-2 align-top">
                <div class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-800">
                  <span class="text-[13px]">
                    {% if r.rating == 1 %}
                      ★☆☆☆☆
                    {% elif r.rating == 2 %}
                      ★★☆☆☆
                    {% elif r.rating == 3 %}
                      ★★★☆☆
                    {% elif r.rating == 4 %}
                      ★★★★☆
                    {% elif r.rating == 5 %}
                      ★★★★★
                    {% else %}
                      -
                    {% endif %}
                  </span>
                  <span class="ml-1 text-[11px] text-slate-500">
                    ({{ r.rating }}/5)
                  </span>
                </div>
              </td>

              <td class="px-3 py-2 align-top">
                {% if r.moderation_status == "approved" %}
                  <span class="inline-flex items-center rounded-full bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700">
                    ● <span class="ml-1">Approvata</span>
                  </span>
                {% elif r.moderation_status == "rejected" %}
                  <span class="inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 text-xs font-semibold text-rose-700">
                    ● <span class="ml-1">Rifiutata</span>
                  </span>
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-amber-50 px-2 py-0.5 text-xs font-semibold text-amber-700">
                    ● <span class="ml-1">In attesa</span>
                  </span>
                {% endif %}
              </td>

              <td class="px-3 py-2 align-top text-xs text-slate-600">
                {% if r.comment %}
                  {{ r.comment|truncatechars:70 }}
                {% else %}
                  <span class="text-slate-400">Nessun commento testuale</span>
                {% endif %}
              </td>

              <td class="px-3 py-2 align-top text-right">
                <div class="flex justify-end gap-1">
                  <a
                    href="{% url 'backoffice:review_detail' r.id %}"
                    class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-2.5 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50"
                  >
                    Dettaglio
                  </a>

                  {% if r.moderation_status != "approved" %}
                    <a
                      href="{% url 'backoffice:review_approve' r.id %}"
                      class="inline-flex items-center rounded-xl bg-emerald-600 px-2.5 py-1 text-xs font-semibold text-white shadow-sm hover:bg-emerald-700"
                    >
                      Approva
                    </a>
                  {% endif %}

                  {% if r.moderation_status != "rejected" %}
                    <a
                      href="{% url 'backoffice:review_reject' r.id %}"
                      class="inline-flex items-center rounded-xl bg-amber-500 px-2.5 py-1 text-xs font-semibold text-white shadow-sm hover:bg-amber-600"
                    >
                      Rifiuta
                    </a>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9" class="px-3 py-6 text-center text-sm text-slate-500">
              Nessuna recensione trovata per i filtri selezionati.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

</div>
</div>
{% endblock %}

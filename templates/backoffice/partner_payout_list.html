{% extends "backoffice/base_admin.html" %}

{% block page_title %}Pagamenti partner{% endblock %}

{% block admin_content %}

<h1 class="text-xl md:text-2xl font-semibold text-slate-900 mb-2">
    Pagamenti partner (payout)
</h1>
<p class="text-sm text-slate-500 mb-6">
    Elenco dei pagamenti delle commissioni verso i partner, con stato e importi.
</p>

<!-- FILTRI -->
<div class="card mb-6">
  <div class="card-body">
    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">

      <div>
        <label class="block text-xs font-semibold text-slate-500 mb-1">
          Partner
        </label>
        <select name="partner"
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">Tutti</option>
          {% for p in partners %}
            <option value="{{ p.id }}"
                    {% if selected_partner == p.id %}selected{% endif %}>
              {{ p.company_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-xs font-semibold text-slate-500 mb-1">
          Stato payout
        </label>
        <select name="status"
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">Tutti</option>
          <option value="draft" {% if selected_status == "draft" %}selected{% endif %}>Bozza</option>
          <option value="confirmed" {% if selected_status == "confirmed" %}selected{% endif %}>Confermato</option>
          <option value="paid" {% if selected_status == "paid" %}selected{% endif %}>Pagato</option>
        </select>
      </div>

      <div class="flex gap-3 flex-wrap">
        <button class="btn btn-primary text-sm" type="submit">
          Filtra
        </button>

        <a href="{% url 'backoffice:partner_payout_list' %}"
           class="btn btn-secondary text-sm">
          Reset
        </a>

        <a href="{% url 'backoffice:partner_commission_list' %}"
           class="btn btn-outline text-sm">
          Vai al report commissioni
        </a>
      </div>

    </form>
  </div>
</div>

<!-- TABELLA PAYOUT -->
<div class="card">
  <div class="card-header flex items-center justify-between">
    <strong>Elenco payout</strong>
    <span class="text-xs text-slate-500">
      Totale payout: {{ payouts|length }}
    </span>
  </div>

  <div class="card-body overflow-x-auto">
    {% if payouts %}
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left text-xs uppercase tracking-wide text-slate-500 border-b border-slate-200">
            <th class="py-2 pr-4">Partner</th>
            <th class="py-2 pr-4">Periodo</th>
            <th class="py-2 pr-4 text-right">Importo Partner</th>
            <th class="py-2 pr-4">Stato</th>
            <th class="py-2 pr-4">Creato il</th>
            <th class="py-2 pr-4">Pagato il</th>
            <th class="py-2 pr-4 text-right">Azioni</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for payout in payouts %}
            <tr class="hover:bg-slate-50">
              <td class="py-2 pr-4 align-top">
                <div class="font-semibold text-slate-900">
                  {{ payout.partner.company_name }}
                </div>
                <div class="text-xs text-slate-500">
                  {{ payout.partner.user.email }}
                </div>
              </td>
              <td class="py-2 pr-4 align-top text-xs text-slate-700">
                {{ payout.period_start }} → {{ payout.period_end }}
              </td>
              <td class="py-2 pr-4 align-top text-right font-semibold text-slate-900">
                {{ payout.total_commission|default:0|floatformat:2 }} €
              </td>
              <td class="py-2 pr-4 align-top">
                {% if payout.status == "draft" %}
                  <span class="inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-medium bg-slate-100 text-slate-700">
                    Bozza
                  </span>
                {% elif payout.status == "confirmed" %}
                  <span class="inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-medium bg-amber-100 text-amber-700">
                    Confermato
                  </span>
                {% elif payout.status == "paid" %}
                  <span class="inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-medium bg-emerald-100 text-emerald-700">
                    Pagato
                  </span>
                {% endif %}
              </td>
              <td class="py-2 pr-4 align-top text-xs text-slate-500">
                {{ payout.created_at|date:"d/m/Y H:i" }}
              </td>
              <td class="py-2 pr-4 align-top text-xs text-slate-500">
                {% if payout.paid_at %}
                  {{ payout.paid_at|date:"d/m/Y H:i" }}
                {% else %}
                  <span class="text-slate-400">—</span>
                {% endif %}
              </td>
              <td class="py-2 pr-4 align-top text-right">
                <a href="{% url 'admin:orders_partnerpayout_change' payout.id %}"
                   class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold bg-indigo-600 text-white hover:bg-indigo-700 js-admin-popup">
                  Apri in admin
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-sm text-slate-500 text-center py-6">
        Nessun payout trovato con i filtri selezionati.
      </p>
    {% endif %}
  </div>
</div>

{% if total_confirmed %}
<div class="mt-6 pt-4 border-t border-slate-200 flex items-center justify-end">
  <span class="text-xs text-slate-500 mr-2">
    Totale importi partner in stato "Confermato":
  </span>
  <span class="text-sm font-semibold text-indigo-700">
    {{ total_confirmed|default:0|floatformat:2 }} €
  </span>
</div>
{% endif %}

{# MODAL ADMIN DJANGO #}
<div id="adminModal"
     class="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[80vh] flex flex-col overflow-hidden">
    <div class="flex items-center justify-between px-4 py-2 border-b border-slate-200">
      <h2 class="text-sm font-semibold text-slate-700">
        Dettaglio payout (admin)
      </h2>
      <button id="adminModalClose"
              class="text-slate-500 hover:text-slate-800 text-lg leading-none">
        ✕
      </button>
    </div>
    <iframe id="adminModalFrame"
            src=""
            class="flex-1 w-full border-0"></iframe>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const links = document.querySelectorAll('.js-admin-popup');
  const modal = document.getElementById('adminModal');
  const iframe = document.getElementById('adminModalFrame');
  const closeBtn = document.getElementById('adminModalClose');

  if (!modal || !iframe || !closeBtn) return;

  links.forEach(function (link) {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      iframe.src = this.href;
      modal.classList.remove('hidden');
    });
  });

  closeBtn.addEventListener('click', function () {
    modal.classList.add('hidden');
    iframe.src = "";
  });

  modal.addEventListener('click', function (e) {
    if (e.target === modal) {
      modal.classList.add('hidden');
      iframe.src = "";
    }
  });
});
</script>

{% endblock %}

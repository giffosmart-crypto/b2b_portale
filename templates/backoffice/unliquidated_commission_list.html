{% extends "backoffice/base_admin.html" %}

{% block page_title %}Commissioni non liquidate{% endblock %}

{% block admin_content %}

<h1 class="text-xl md:text-2xl font-semibold text-slate-900 mb-2">
    Commissioni non liquidate
</h1>
<p class="text-sm text-slate-500 mb-6">
    Elenco delle righe d'ordine con commissioni ancora da liquidare.
</p>

<!-- FILTRI -->
<div class="card mb-6">
  <div class="card-body">
    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">

      <div>
        <label class="block text-xs font-semibold text-slate-500 mb-1">
          Partner
        </label>
        <select name="partner"
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="">Tutti</option>
          {% for p in partners %}
            <option value="{{ p.id }}"
                    {% if selected_partner == p.id %}selected{% endif %}>
              {{ p.company_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-xs font-semibold text-slate-500 mb-1">
          Periodo da
        </label>
        <input type="date"
               name="period_start"
               value="{{ period_start }}"
               class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                      focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>

      <div>
        <label class="block text-xs font-semibold text-slate-500 mb-1">
          Periodo a
        </label>
        <input type="date"
               name="period_end"
               value="{{ period_end }}"
               class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                      focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>

      <div class="flex gap-3 flex-wrap">
        <button class="btn btn-primary text-sm" type="submit">
          Filtra
        </button>

        <a href="{% url 'backoffice:unliquidated_commission_list' %}"
           class="btn btn-secondary text-sm">
          Reset
        </a>

        <a href="{% url 'backoffice:partner_commission_list' %}"
           class="btn btn-outline text-sm">
          Torna al report partner
        </a>
      </div>

    </form>
  </div>
</div>

<!-- TABELLA -->
<div class="card">
  <div class="card-header flex items-center justify-between">
    <strong>Righe non liquidate</strong>
    <span class="text-xs text-slate-500">
      Totale righe: {{ items|length }}
    </span>
  </div>

  <div class="card-body overflow-x-auto">
    {% if items %}
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left text-xs uppercase tracking-wide text-slate-500 border-b border-slate-200">
            <th class="py-2 pr-4">Partner</th>
            <th class="py-2 pr-4">Ordine</th>
            <th class="py-2 pr-4">Data ordine</th>
            <th class="py-2 pr-4">Prodotto</th>
            <th class="py-2 pr-4 text-right">Totale riga</th>
            <th class="py-2 pr-4 text-right">Commissione</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for item in items %}
            <tr class="hover:bg-slate-50">
              <td class="py-2 pr-4 align-top text-xs">
                <div class="font-semibold text-slate-900">
                  {{ item.partner.company_name }}
                </div>
                <div class="text-[11px] text-slate-500">
                  {{ item.partner.user.email }}
                </div>
              </td>
              <td class="py-2 pr-4 align-top text-xs">
                #{{ item.order.id }}
              </td>
              <td class="py-2 pr-4 align-top text-xs text-slate-500">
                {{ item.order.created_at|date:"d/m/Y" }}
              </td>
              <td class="py-2 pr-4 align-top text-xs">
                {{ item.product.name }}
              </td>
              <td class="py-2 pr-4 align-top text-right text-xs">
                {{ item.total_price|floatformat:2 }} €
              </td>
              <td class="py-2 pr-4 align-top text-right text-xs font-semibold text-amber-700">
                {{ item.commission_amount|floatformat:2 }} €
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-sm text-slate-500 text-center py-6">
        Nessuna commissione non liquidata trovata con i filtri selezionati.
      </p>
    {% endif %}
  </div>
</div>

{% if total_unliquidated %}
<div class="mt-6 pt-4 border-t border-slate-200 flex items-center justify-end">
  <span class="text-xs text-slate-500 mr-2">
    Totale commissioni non liquidate:
  </span>
  <span class="text-sm font-semibold text-amber-700">
    {{ total_unliquidated|default:0|floatformat:2 }} €
  </span>
</div>
{% endif %}

{% endblock %}

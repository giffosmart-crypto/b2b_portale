{% extends "backoffice/base_admin.html" %}

{% block page_title %}Struttura: {{ structure.name }}{% endblock %}

{% block admin_content %}

<h1 class="text-xl md:text-2xl font-semibold text-slate-900 mb-2">
    Struttura: {{ structure.name }}
</h1>
<p class="text-sm text-slate-500 mb-6">
    Dettaglio struttura cliente e ordini associati.
</p>

<!-- DATI STRUTTURA -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">

    <div class="card">
  <div class="card-header">
    <div>
      <div class="text-sm font-semibold text-slate-900">Dati struttura</div>
      <div class="text-xs text-slate-500">Anagrafica e contatti</div>
    </div>
  </div>

  <div class="card-body">
    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">

      <div>
        <dt class="text-[11px] uppercase tracking-wide text-slate-500">Cliente</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900 break-words">
          {{ structure.owner.email }}
        </dd>
      </div>

      <div>
        <dt class="text-[11px] uppercase tracking-wide text-slate-500">Nome struttura</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          {{ structure.name }}
        </dd>
      </div>

      <div>
        <dt class="text-[11px] uppercase tracking-wide text-slate-500">Indirizzo</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900 break-words">
          {{ structure.address }}
        </dd>
      </div>

      <div>
        <dt class="text-[11px] uppercase tracking-wide text-slate-500">Comune</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          {{ structure.city }}
        </dd>
      </div>

      <div>
        <dt class="text-[11px] uppercase tracking-wide text-slate-500">Nazione</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          {{ structure.country }}
        </dd>
      </div>

      <div>
        <dt class="text-[11px] uppercase tracking-wide text-slate-500">CAP</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          {{ structure.zip_code }}
        </dd>
      </div>

      <div class="sm:col-span-2">
        <dt class="text-[11px] uppercase tracking-wide text-slate-500">Telefono</dt>
        <dd class="mt-1 text-sm font-medium text-slate-900">
          {{ structure.phone|default:"—" }}
        </dd>
      </div>

    </dl>
  </div>
</div>

    <div class="card">
        <div class="card-header">
            <strong>Azioni</strong>
        </div>
        <div class="card-body text-sm space-y-3">
            <p>
                <a href="{% url 'backoffice:client_structure_list' %}"
                   class="btn btn-secondary btn-sm">
                    ← Torna all'elenco strutture
                </a>
            </p>
            <p>
                <a href="{% url 'admin:accounts_clientstructure_change' structure.id %}"
                   class="btn btn-primary btn-sm js-admin-popup">
                    Modifica in Django admin
                </a>
            </p>
        </div>
    </div>

</div>

<!-- ORDINI ASSOCIATI -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <strong>Ordini associati a questa struttura</strong>
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-striped mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Stato</th>
                    <th>Totale</th>
                    <th>Data</th>
                    <th class="text-right"></th>
                </tr>
            </thead>
            <tbody>
            {% for o in orders %}
                <tr>
                    <td>#{{ o.id }}</td>
                    <td>{{ o.client.email }}</td>
                    <td>{{ o.status }}</td>
                    <td>{{ o.total }}</td>
                    <td>{{ o.created_at|date:"d/m/Y H:i" }}</td>
                    <td class="text-right">
                        <a href="{% url 'backoffice:order_detail' o.id %}"
                           class="btn btn-sm btn-primary">
                            Dettaglio ordine
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4">
                        Nessun ordine associato a questa struttura.
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# MODAL ADMIN DJANGO #}
<div id="adminModal"
     class="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[80vh] flex flex-col overflow-hidden">

    <div class="flex items-center justify-between px-4 py-2 border-b border-slate-200">
      <h2 class="text-sm font-semibold text-slate-700">
        Modifica struttura in Django admin
      </h2>
      <button id="adminModalClose"
              class="text-slate-500 hover:text-slate-800 text-lg leading-none">
        ✕
      </button>
    </div>

    <iframe id="adminModalFrame"
            src=""
            class="flex-1 w-full border-0"></iframe>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const links = document.querySelectorAll('.js-admin-popup');
  const modal = document.getElementById('adminModal');
  const iframe = document.getElementById('adminModalFrame');
  const closeBtn = document.getElementById('adminModalClose');

  if (!modal || !iframe || !closeBtn) return;

  links.forEach(function (link) {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      iframe.src = this.href;
      modal.classList.remove('hidden');
    });
  });

  closeBtn.addEventListener('click', function () {
    modal.classList.add('hidden');
    iframe.src = "";
  });

  // chiudi cliccando sullo sfondo scuro
  modal.addEventListener('click', function (e) {
    if (e.target === modal) {
      modal.classList.add('hidden');
      iframe.src = "";
    }
  });
});
</script>

{% endblock %}

{% extends "backoffice/base_admin.html" %}

{% block page_title %}Report commissioni{% endblock %}

{% block admin_content %}

<div class="mb-6">
  <h1 class="text-xl md:text-2xl font-semibold text-slate-900 mb-1">
    Report commissioni portale & guadagni partner
  </h1>
  <p class="text-sm text-slate-500">
    Analisi dettagliata delle commissioni generate dal portale e degli importi riconosciuti ai partner,
    filtrabili per periodo e partner.
  </p>
</div>

<!-- FILTRI -->
<div class="card mb-6">
  <div class="card-body">
    <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div>
        <label class="form-label text-xs font-semibold text-slate-500">Partner</label>
        <select name="partner" class="form-select">
          <option value="">Tutti</option>
          {% for p in partners %}
            <option value="{{ p.id }}" {% if selected_partner == p.id %}selected{% endif %}>
              {{ p.company_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="form-label text-xs font-semibold text-slate-500">Partner A (confronto)</label>
        <select name="compare_partner_1" class="form-select">
          <option value="">Seleziona</option>
          {% for p in partners %}
            <option value="{{ p.id }}" {% if selected_compare_partner_1 == p.id %}selected{% endif %}>
              {{ p.company_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="form-label text-xs font-semibold text-slate-500">Partner B (confronto)</label>
        <select name="compare_partner_2" class="form-select">
          <option value="">Seleziona</option>
          {% for p in partners %}
            <option value="{{ p.id }}" {% if selected_compare_partner_2 == p.id %}selected{% endif %}>
              {{ p.company_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="form-label text-xs font-semibold text-slate-500">Periodo da</label>
        <input type="date" name="period_start" value="{{ period_start }}" class="form-input" />
      </div>

      <div>
        <label class="form-label text-xs font-semibold text-slate-500">Periodo a</label>
        <input type="date" name="period_end" value="{{ period_end }}" class="form-input" />
      </div>

      <div class="md:col-span-2 flex gap-2">
        <button type="submit" class="btn btn-primary w-full">
          Applica filtri
        </button>
        <a href="{% url 'backoffice:commission_report' %}" class="btn btn-light w-full">
          Reset
        </a>
      </div>
    </form>
  </div>
</div>

<!-- KPI -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="card">
    <div class="card-body">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 mb-1">
        Fatturato periodo
      </p>
      <p class="text-2xl font-semibold text-slate-900 mb-1">
        {{ total_revenue|floatformat:2 }} €
      </p>
      <p class="text-xs text-slate-500">
        Somma totale delle righe d'ordine non annullate.
      </p>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 mb-1">
        Commissioni portale
      </p>
      <p class="text-2xl font-semibold text-slate-900 mb-1">
        {{ total_portal_commission|floatformat:2 }} €
      </p>
      <p class="text-xs text-slate-500">
        Quota trattenuta dal portale sulle righe filtrate.
      </p>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 mb-1">
        Guadagni partner
      </p>
      <p class="text-2xl font-semibold text-emerald-600 mb-1">
        {{ total_partner_earnings|floatformat:2 }} €
      </p>
      <p class="text-xs text-slate-500">
        Totale riconosciuto ai partner (netto).
      </p>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400 mb-1">
        Ordini & partner
      </p>
      <p class="text-2xl font-semibold text-slate-900 mb-1">
        {{ order_count }} ordini · {{ partner_count }} partner
      </p>
      <p class="text-xs text-slate-500">
        Nel perimetro dei filtri selezionati.
      </p>
    </div>
  </div>
</div>

<!-- AZIONI EXPORT GLOBALI -->
<div class="flex flex-wrap gap-2 justify-end mb-4">
  <a href="{% url 'backoffice:commission_report_export_csv' %}?partner={{ selected_partner|default_if_none:'' }}&period_start={{ period_start }}&period_end={{ period_end }}"
   class="btn btn-light text-xs">
  Esporta CSV
</a>
<a href="{% url 'backoffice:commission_report_export_xlsx' %}?partner={{ selected_partner|default_if_none:'' }}&period_start={{ period_start }}&period_end={{ period_end }}"
   class="btn btn-light text-xs">
  Esporta Excel
</a>
<a href="{% url 'backoffice:commission_report_export_pdf' %}?partner={{ selected_partner|default_if_none:'' }}&period_start={{ period_start }}&period_end={{ period_end }}"
   class="btn btn-light text-xs">
  Esporta PDF
</a>
</div>

<!-- GRAFICI PRINCIPALI -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
  <div class="card">
    <div class="card-header bg-sky-600 text-white">
      <strong>Andamento giornaliero (fatturato vs commissioni)</strong>
    </div>
    <div class="card-body">
      <div class="h-64">
        <canvas id="commissionTimeChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-cyan-500 text-white">
      <strong>Top partner per fatturato</strong>
    </div>
    <div class="card-body">
      <div class="h-64">
        <canvas id="partnerChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- GRAFICI SECONDARI -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
  <div class="card">
    <div class="card-header bg-slate-800 text-white">
      <strong>Fatturato & guadagni per mese</strong>
    </div>
    <div class="card-body">
      <div class="h-64">
        <canvas id="monthChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-emerald-600 text-white">
      <strong>Top categorie prodotto per fatturato</strong>
    </div>
    <div class="card-body">
      <div class="h-64">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- GRAFICO CONFRONTO PARTNER -->
<div class="grid grid-cols-1 gap-4 mb-6">
  <div class="card">
    <div class="card-header bg-amber-500 text-white">
      <strong>Confronto tra partner (fatturato, commissioni, guadagno, ordini)</strong>
    </div>
    <div class="card-body">
      <p class="text-xs text-slate-500 mb-2">
        Seleziona due partner nei filtri in alto per visualizzare il confronto.
      </p>
      <div class="h-64">
        <canvas id="partnerCompareChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- TABELLA RIEPILOGO PER PARTNER - LAYOUT PREMIUM -->
<div class="card mb-10">
  <div class="card-header flex items-center justify-between bg-slate-50">
    <div>
      <p class="text-[11px] font-semibold tracking-wide text-slate-500 uppercase">
        Dettaglio commissioni per partner
      </p>
      <p class="text-xs text-slate-400">
        Panoramica sintetica delle performance per partner nel periodo selezionato.
      </p>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="overflow-x-auto">
      <table class="min-w-full text-xs md:text-sm">
        <thead>
          <tr class="border-b border-slate-200">
            <th class="py-2 px-4 text-left text-[11px] font-semibold text-slate-500 uppercase">
              Partner
            </th>
            <th class="py-2 px-4 text-right text-[11px] font-semibold text-slate-500 uppercase">
              Fatturato (€)
            </th>
            <th class="py-2 px-4 text-right text-[11px] font-semibold text-slate-500 uppercase">
              Commissioni portale (€)
            </th>
            <th class="py-2 px-4 text-right text-[11px] font-semibold text-slate-500 uppercase">
              Guadagno partner (€)
            </th>
            <th class="py-2 px-4 text-right text-[11px] font-semibold text-slate-500 uppercase">
              N. ordini
            </th>
            <th class="py-2 px-4 text-right text-[11px] font-semibold text-slate-500 uppercase">
              Azioni
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for row in partner_rows %}
            <tr class="hover:bg-slate-50 transition-colors">
              <!-- Partner -->
              <td class="py-3 px-4 align-top">
                <div class="flex flex-col">
                  <span class="font-medium text-slate-900">
                    {{ row.partner__company_name }}
                  </span>
                </div>
              </td>

              <!-- Fatturato -->
              <td class="py-3 px-4 text-right align-top">
                <span class="font-medium text-slate-900">
                  {{ row.revenue|floatformat:2 }}
                </span>
              </td>

              <!-- Commissioni portale -->
              <td class="py-3 px-4 text-right align-top">
                <span class="font-medium text-slate-700">
                  {{ row.portal_commission|floatformat:2 }}
                </span>
              </td>

              <!-- Guadagno partner -->
              <td class="py-3 px-4 text-right align-top">
                <span class="font-semibold text-emerald-600">
                  {{ row.partner_earnings|floatformat:2 }}
                </span>
              </td>

              <!-- N. ordini -->
              <td class="py-3 px-4 text-right align-top">
                <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium text-slate-700">
                  {{ row.order_count }}
                </span>
              </td>

              <!-- Azioni -->
              <td class="py-3 px-4 text-right align-top">
                <div class="flex flex-wrap justify-end gap-1 text-[11px]">
                  <a href="{% url 'backoffice:commission_report_detail' %}?partner={{ row.partner__id }}&period_start={{ period_start }}&period_end={{ period_end }}"
                     class="px-2 py-0.5 rounded-full border border-slate-300 text-slate-700 hover:bg-slate-50">
                    Dettaglio righe
                  </a>
                  <a href="{% url 'backoffice:unliquidated_commission_list' %}?partner={{ row.partner__id }}&period_start={{ period_start }}&period_end={{ period_end }}"
                     class="px-2 py-0.5 rounded-full border border-sky-200 text-sky-700 hover:bg-sky-50">
                    Non liquidate
                  </a>
                  <a href="{% url 'backoffice:liquidated_commission_list' %}?partner={{ row.partner__id }}&period_start={{ period_start }}&period_end={{ period_end }}"
                     class="px-2 py-0.5 rounded-full border border-emerald-200 text-emerald-700 hover:bg-emerald-50">
                    Liquidate
                  </a>
                  <a href="{% url 'backoffice:commission_partner_pdf' row.partner__id %}?period_start={{ period_start }}&period_end={{ period_end }}"
                     class="px-2 py-0.5 rounded-full border border-rose-200 text-rose-700 hover:bg-rose-50">
                    PDF partner
                  </a>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="py-4 px-4 text-center text-sm text-slate-500">
                Nessun dato disponibile per i filtri selezionati.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- SCRIPT GRAFICI -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const timeLabels = {{ chart_time_labels|safe }};
    const timeRevenue = {{ chart_time_revenue|safe }};
    const timePortalComm = {{ chart_time_portal_commission|safe }};
    const timePartnerEarn = {{ chart_time_partner_earnings|safe }};

    const monthLabels = {{ chart_month_labels|safe }};
    const monthRevenue = {{ chart_month_revenue|safe }};
    const monthPartnerEarn = {{ chart_month_partner_earnings|safe }};

    const partnerLabels = {{ chart_partner_labels|safe }};
    const partnerRevenue = {{ chart_partner_revenue|safe }};
    const partnerPartnerEarn = {{ chart_partner_partner_earnings|safe }};

    const categoryLabels = {{ chart_category_labels|safe }};
    const categoryRevenue = {{ chart_category_revenue|safe }};
    const categoryPartnerEarn = {{ chart_category_partner_earnings|safe }};

    const compareMetricLabels = {{ chart_compare_metric_labels|safe }};
    const comparePartner1Values = {{ chart_compare_partner1_values|safe }};
    const comparePartner2Values = {{ chart_compare_partner2_values|safe }};
    const comparePartner1Name = "{{ compare_partner_1_name|default_if_none:'' }}";
    const comparePartner2Name = "{{ compare_partner_2_name|default_if_none:'' }}";

    // Andamento giornaliero
    const timeCtx = document.getElementById('commissionTimeChart');
    if (timeCtx && Array.isArray(timeLabels) && timeLabels.length > 0) {
      new Chart(timeCtx, {
        type: 'line',
        data: {
          labels: timeLabels,
          datasets: [
            { label: 'Fatturato', data: timeRevenue, tension: 0.2, borderWidth: 2 },
            { label: 'Commissioni portale', data: timePortalComm, tension: 0.2, borderWidth: 2 },
            { label: 'Guadagno partner', data: timePartnerEarn, tension: 0.2, borderWidth: 2 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Top partner per fatturato
    const partnerCtx = document.getElementById('partnerChart');
    if (partnerCtx && Array.isArray(partnerLabels) && partnerLabels.length > 0) {
      new Chart(partnerCtx, {
        type: 'bar',
        data: {
          labels: partnerLabels,
          datasets: [
            { label: 'Fatturato', data: partnerRevenue, borderWidth: 1 },
            { label: 'Guadagno partner', data: partnerPartnerEarn, borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Fatturato & guadagni per mese
    const monthCtx = document.getElementById('monthChart');
    if (monthCtx && Array.isArray(monthLabels) && monthLabels.length > 0) {
      new Chart(monthCtx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            { label: 'Fatturato', data: monthRevenue, borderWidth: 1 },
            { label: 'Guadagno partner', data: monthPartnerEarn, borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: {
            x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Top categorie prodotto
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx && Array.isArray(categoryLabels) && categoryLabels.length > 0) {
      new Chart(categoryCtx, {
        type: 'bar',
        data: {
          labels: categoryLabels,
          datasets: [
            { label: 'Fatturato', data: categoryRevenue, borderWidth: 1 },
            { label: 'Guadagno partner', data: categoryPartnerEarn, borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: {
            x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Confronto tra due partner
    const compareCtx = document.getElementById('partnerCompareChart');
    if (
      compareCtx &&
      Array.isArray(compareMetricLabels) &&
      compareMetricLabels.length > 0 &&
      comparePartner1Name &&
      comparePartner2Name
    ) {
      new Chart(compareCtx, {
        type: 'bar',
        data: {
          labels: compareMetricLabels,
          datasets: [
            { label: comparePartner1Name, data: comparePartner1Values, borderWidth: 1 },
            { label: comparePartner2Name, data: comparePartner2Values, borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  })();
</script>

{% endblock %}

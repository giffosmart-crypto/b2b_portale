{% extends "base.html" %}

{% block title %}Report & grafici{% endblock %}
{% block page_title %}Report & grafici{% endblock %}

{% block content %}

<div class="flex items-center justify-between mb-6">
    <p class="text-sm text-slate-600">
        Report e grafici relativi alle tue attività come partner.
    </p>

    <!-- Filtro periodo -->
    <form method="get" class="flex items-center gap-2 text-sm">
        <label for="period" class="text-slate-600">
            Periodo:
        </label>
        <select id="period" name="period"
                class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-sm"
                onchange="this.form.submit()">
            <option value="3" {% if current_period == '3' %}selected{% endif %}>
                Ultimi 3 mesi
            </option>
            <option value="6" {% if current_period == '6' %}selected{% endif %}>
                Ultimi 6 mesi
            </option>
            <option value="12" {% if current_period == '12' %}selected{% endif %}>
                Ultimi 12 mesi
            </option>
        </select>
    </form>
</div>

<!-- GRAFICI ANDAMENTO -->
<div class="mb-10">
    <h2 class="text-lg font-semibold text-slate-900 mb-3">Andamento vendite e ordini</h2>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white border border-slate-200 rounded-xl p-4">
            <h3 class="text-sm font-semibold text-slate-800 mb-2">Vendite (€/mese)</h3>
            <div class="h-52">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-xl p-4">
            <h3 class="text-sm font-semibold text-slate-800 mb-2">Numero ordini (per mese)</h3>
            <div class="h-52">
                <canvas id="ordersChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- GRAFICO PERFORMANCE STATI -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-3">Distribuzione stati righe d'ordine</h2>

    <div class="bg-white border border-slate-200 rounded-xl p-4 max-w-xl">
        <div class="h-64">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    {{ block.super }}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dati dal backend (già in formato JSON)
        const revenueLabels = {{ revenue_chart_labels|safe }};
        const revenueData = {{ revenue_chart_data|safe }};
        const ordersLabels = {{ orders_chart_labels|safe }};
        const ordersData = {{ orders_chart_data|safe }};
        const statusLabels = {{ status_chart_labels|safe }};
        const statusData = {{ status_chart_data|safe }};

        // Grafico vendite
        (function() {
            const el = document.getElementById('revenueChart');
            if (!el) return;
            new Chart(el.getContext('2d'), {
                type: 'line',
                data: {
                    labels: revenueLabels,
                    datasets: [{
                        label: 'Vendite (€)',
                        data: revenueData,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        })();

        // Grafico andamento ordini
        (function() {
            const el = document.getElementById('ordersChart');
            if (!el) return;
            new Chart(el.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ordersLabels,
                    datasets: [{
                        label: 'Numero ordini',
                        data: ordersData,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, precision: 0 }
                    }
                }
            });
        })();

        // Grafico performance stati
        (function() {
            const el = document.getElementById('statusChart');
            if (!el) return;
            new Chart(el.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        label: 'Numero righe',
                        data: statusData
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, precision: 0 }
                    }
                }
            });
        })();
    </script>
{% endblock %}
